# 线程

## 进程与线程

进程具有两个独立的特征，构成进程并发执行的基础：

- 进程是资源拥有者——进程包括容纳进程映像虚拟地址空间，因此进程是**资源分配保护单位**
- 进程参与调度/执行——沿着执行轨迹与其他进程交替地执行，因此进程是**调度分派单位**

但是进程存在问题:

- 进程创建、切换开销大
- 进程通信代价大：需要经过内核
- 进程间的并发性粒度较粗，并发度不高
- 不适合并行计算和分布并行计算的要求
- 不适合客户/服务器计算的要求。

解决方法：

- 操作系统分别对待这两个特征（在进程的基础上引入线程）
- 将**调度单位**称作线程或轻权进程（轻量级进程）
- **资源拥有者**称为进程或任务

操作系统中**引入进程**的目的是为了使多个程序**并发执行**，以改善资源使用率和提高系统效率

操作系统中再**引入线程**，则是为了**减少**进程并发执行时所付出的**时空开销**，使得并发粒度更细、并发性更好。

进程作为系统资源分配和保护的独立单位，不需要频繁地切换

线程作为系统调度和分派的基本单位，能轻装运行，能被频繁地调度和切换

### 多线程

多线程指的是 OS 支持单进程内多个、并发的执行轨迹的能力。

线程是进程中能够独立执行的实体（控制流），是**处理器调度和分派的基本单位**。线程是进程的组成部分，每个进程内允许包含多个并发执行的实体（控制流），这就是多线程

支持多线程系统中，进程是资源分配和保护的单位：

- 它有容纳进程映像的虚拟地址空间
- 它可以对资源进行受保护的访问：处理器、进程间通信、文件、I/O 资源

每个线程：

- 有它的运行状态
- 不运行时要保存线程上下文
- 需要一个执行栈
- 有一些静态存储空间用于局部变量
- 可访问所在进程的内存和资源（此进程的所有线程共享这些）

线程之间是并发执行的

#### 线程的优点

- 已有进程内创建一个线程比创建全新进程用时少
- 终止一个线程比进程用时少
- 同进程内线程切换比进程切换用时少
- 线程提高了程序间的通信效率：同进程间线程可以不经过内核相互通信
- 减小并发执行的时间和空间开销，因此容许在系统中建立更多的线程来提高并发程度
- 适合多处理器系统（单处理器也能有很大优势）

#### 线程的控制

线程的控制与进程管理类似。一些进程活动会影响一个进程中所有线程，操作系统必须在进程级别来管理线程

例如：挂起一个进程会挂起其中的所有线程，终止一个进程会终止其中的所有线程

#### 线程的功能

线程有执行的不同状态，可与其他线程同步。

和进程一样，线程也有自己的运行状态，需要同步（进程的多个线程共享进程的地址空间和其他资源，须要同步各个线程的活动）

线程的主要状态：运行、就绪和阻塞。注意：**线程没有挂起状态**。挂起状态是进程级别的概念。

线程的功能与状态改变有关：

- Spawn 派生
  - 派生进程同时会派生一个线程，进程中线程可派生另一线程
  - 派生时分配寄存器上下文、栈
- Block 阻塞
- Unblock 解除阻塞
- Finish (thread)结束/撤销
  - 释放寄存器上下文、栈

## 线程的分类

线程分为以下两类：

- User Level Thread (ULT) 用户级线程
- Kernel level Thread (KLT) 内核级线程，又称 kernel-supported threads 内核支持线程，lightweight processes 轻权/轻量级进程

### ULT 用户级线程

用户级线程**由应用程序负责**所有线程管理，**内核不知线程的存在**（这会导致有些内核调度的特性无法使用，调度的单位仍为进程）

优点：

- 用户线程切换不需要内核特权：无需用户态/核心态切换，所以速度特别快
- 用户线程调度算法可针对应用优化：通常采用非抢先式和更简单的规则
- 能运行在任何 OS 上

缺点：

- 一个线程发起系统调用而被阻塞，则整个进程中的线程都被阻塞。
- 处理器（时间片）分配给进程，多线程的应用程序得不到多处理器技术的好处（线程不能并行执行）

如何克服这些缺点：

- 可以考虑将应用程序写成多进程处理的，但是这样就丧失了进程轻量化的优点。
- Jacketing 套管技术，将阻塞调用转换为非阻塞调用（略）

### KLT 内核级线程

由内核维护进、线程的上下文信息，应用程序不参与线程的管理。此时调度就以线程为单位，Windows 就支持这样的内核级线程。

优点：

- 内核可以同时在多处理器上调度同进程的多个线程
- 一个进程的线程阻塞，内核可调度同进程的另一线程
- 内核例程本身就可以是多线程的

缺点：同进程中一个线程切换到另一线程需要内核的模式切换（稍微增加了开销）

### 内核级与用户级混合线程

在混合系统中，线程创建完全在用户空间中完成，线程的调度和同步也在应用程序中进行。

一个应用程序中的多个 ULT 会被映射到一些（小于等于 ULT 数）的 KLT 上。

为使整体性能最佳，程序员可为特定应用程序和处理器调节 KLT 的数量。

在混合方法中，同一个应用程序中的多个线程可在多个处理器上并行地运行，某个会引起阻塞的系统调用不会阻塞整个进程。

设计正确时，这种方法可结合纯 ULT 方法和纯 KLT 方法的优点，并克服它们的缺点。Solaris 操作系统是使用混合方法的很好例子。

在 Linux 中，线程是通过轻量化进程实现的，本质上仍为[进程](进程描述与控制.md)，有自己的 PID。
